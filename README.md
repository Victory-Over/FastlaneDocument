# FastlaneDocument

## fastlaneå®˜ç½‘åœ°å€ 

https://docs.fastlane.tools/ (æœ‰è¯¦ç»†æ•™ç¨‹)

### ç¯å¢ƒæ£€æŸ¥ï¼š

#### 1ã€æ£€æŸ¥rubyç‰ˆæœ¬

æŸ¥çœ‹æœ¬æœºå·²å®‰è£…çš„rubyç‰ˆæœ¬å·ï¼Œè¦æ±‚ç‰ˆæœ¬>2.0

```
$ ruby -v
```

æ˜¾ç¤º

```command
ruby 2.0.0p648 (2015-12-16 revision 53162) [universal.x86_64-darwin16]
```


#### 2ã€ä½¿ç”¨rvmç®¡ç†rubyç‰ˆæœ¬

å®‰è£…rvm
```
$ curl -L https://get.rvm.io | bash -s stable
```

ä½¿ç”¨rvm

```
$ source /Users/dayku/.rvm/scripts/rvm
```

åˆ—å‡ºrubyå¯å®‰è£…ç‰ˆæœ¬åˆ—è¡¨

```
$ rvm list known
```

å®‰è£…ruby 2.4

```
$ rvm install 2.4
```

å®‰è£…è¿‡ç¨‹ä¸­ä¼šæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æœ‰å®‰è£…Homebrewï¼ŒæŒ‰ç…§é»˜è®¤è·¯å¾„å®‰è£…Homebrewï¼Œè¾“å…¥å›è½¦é”®

ä½¿ç”¨ruby 2.4

```
$ rvm use 2.4.1 --default
```


#### 3ã€æ£€æŸ¥Xcodeçš„CLTæ˜¯å¦å®‰è£…

å®‰è£…Command Line Tools

```
$ xcode-select --install
```

å¦‚æœæ²¡æœ‰å®‰è£…åˆ™è‡ªåŠ¨å®‰è£…ï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºä¸€ä¸‹é”™è¯¯

```command
xcode-select: error: command line tools are already installed, use "Software Update" to install updates
```

#### ç³»ç»Ÿç¯å¢ƒé…ç½®
â‘ ã€å®‰è£…JDK1.8.0

è¦ä¿æŒå’Œé¡¹ç›®é‡Œä½¿ç”¨çš„JDKç‰ˆæœ¬ä¸€è‡´

â‘¡ã€é…ç½®ANDROID_HOMEå…¨å±€å‚æ•°

```
$ vi ~/.bash_profile
```

```command
ANDROID_HOME=/Users/dayku/Library/Android/sdk
export ANDROID_HOME
export PATH=$PATH:$ANDROID_HOME/tools
export PATH=$PATH:$ANDROID_HOME/platform-tools
```
```
$ source ~/.bash_profile
```

##### 

### å®‰è£…fastlane

```
$ [sudo] gem install fastlane -NV
```

æŸ¥çœ‹å®‰è£…çš„fastlaneç‰ˆæœ¬

```
$ fastlane --version
```

æ˜¾ç¤º

```command
fastlane installation at path:
/Users/xiaonan/.rvm/gems/ruby-2.4.1/gems/fastlane-2.94.0/bin/fastlane
-----------------------------
[âœ”] ğŸš€ 
fastlane 2.94.0
```

###  åˆå§‹åŒ–fastlane

é¦–å…ˆåœ¨ç»ˆç«¯è¿›å»é¡¹ç›®æ ¹ç›®å½•

ç„¶ååˆå§‹åŒ–fastlane

```
$ fastlane init
```

æœŸé—´ä¼šè¯¢é—®é¡¹ç›®çš„åŒ…å

```command
Package Name (com.krausefx.app): ***.***.***
```

è¯¢é—®ä¸Šä¼ åˆ°Google Playéœ€è¦çš„jsonæ–‡ä»¶è·¯å¾„ï¼Œç›´æ¥å›è½¦

```
Path to the json secret file: 
```

è¯¢é—®æ˜¯å¦ç®¡ç†å¹¶ä¸‹è½½Google Playå…ƒæ•°æ®åŠæˆªå›¾ï¼Œé€‰n

```
 Download existing metadata and setup metadata management? (y/n)
```

ä¹‹ååˆå§‹åŒ–å‘½ä»¤ä¼šè‡ªåŠ¨æ‰§è¡Œ```bundle update```ä¸‹è½½é¡¹ç›®éœ€è¦çš„ä¾èµ–åº“

åˆå§‹åŒ–å®Œæˆåï¼Œé¡¹ç›®çš„æ ¹ç›®å½•ä¼šå¤š2ä¸ªæ–‡ä»¶ï¼šGemfileã€Gemfile.lockï¼Œå†…å®¹å’ŒiOSé¡¹ç›®åˆ›å»ºçš„ç±»ä¼¼ç±»å‹

åˆå§‹åŒ–è‡ªåŠ¨åœ¨æ ¹ç›®å½•åˆ›å»ºfastlaneæ–‡ä»¶å¤¹åŠæ–‡ä»¶

```
$ cd fastlane && ls
Appfile            Fastfile
```

+ Appfileæ–‡ä»¶è®°å½•Appçš„json_key_fileï¼Œpackage_nameä¿¡æ¯ã€‚
+ Fastfileè„šæœ¬çš„æ ¸å¿ƒæ‰§è¡Œæ–‡ä»¶.æœ‰å‡ ä¸ªé»˜è®¤çš„é€‰é¡¹ï¼Œå¯ç›´æ¥ä½¿ç”¨ã€‚


### å®‰è£…fastlaneæ’ä»¶

#### 1ã€è’²å…¬è‹±æ’ä»¶

é€šè¿‡è¯¥å‘½ä»¤å®‰è£…æ’ä»¶

```
$ fastlane add_plugin pgyer
```
å®‰è£…ç¨‹åºä¼šè‡ªåŠ¨åœ¨```./fastlane/```ä¸‹åˆ›å»ºPluginfileæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ï¼š

```ruby
# Autogenerated by fastlane
#
# Ensure this file is checked in to source control!

gem 'fastlane-plugin-pgyer'
```

å®‰è£…æœŸé—´åˆ¤æ–­é¡¹ç›®å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡pluginsï¼Œä¼šè¯¢é—®æ˜¯å¦å…è®¸ä¿®æ”¹Gemfileæ–‡ä»¶ï¼Œé€‰æ‹©y
ä¿®æ”¹ä¹‹åçš„Gemfileå†…å®¹

```ruby
source "https://rubygems.org"


gem "cocoapods", "1.5.0"
gem "fastlane", "2.94.0"

plugins_path = File.join(File.dirname(__FILE__), 'fastlane', 'Pluginfile')
eval_gemfile(plugins_path) if File.exist?(plugins_path)
```

åœ¨æ–°æœºå™¨ä¸Šå®‰è£…plugins, ç”¨äºåœ¨ä»gitä¸Šæ‹‰å–åŒ…å«fastlaneé…ç½®æ–‡ä»¶çš„ä»£ç åä½¿ç”¨

```
$ fastlane install_plugins
```

#### 2ã€æŸ¥çœ‹apkä¿¡æ¯æ’ä»¶

`åªæœ‰Androidé¡¹ç›®éœ€è¦å®‰è£…`

```
$ fastlane add_plugin analyze_apk
```

#### 2ã€æŸ¥çœ‹æ‰€æœ‰æ’ä»¶

é€šè¿‡è¯¥å‘½ä»¤æŸ¥æ‰¾æ’ä»¶ï¼Œæ³¨æ„åœ¨æ²¡æœ‰å®‰è£…è¿‡pluginsæ—¶ï¼Œä¼šå‡ºé”™

```
$ fastlane search_plugins
```

### Fastfileæ–‡ä»¶ç¼–è¾‘åŠæ ¼å¼è¯´æ˜


```ruby

default_platform(:android)

ENV["JG_ANDROID_SDK_DIR"] = %x( echo $ANDROID_HOME ).chomp

platform :android do

  desc 'æ„å»ºå‰çš„å‡†å¤‡å·¥ä½œ'
  desc 'è¿™æ˜¯ä¸€ä¸ªç§æœ‰ä»»åŠ¡ï¼Œä»…ä¾› Fastfile å†…éƒ¨ lane è°ƒç”¨ä½¿ç”¨'
  private_lane :prepare do
    # æ‹‰å–æœ€æ–°ä»£ç 
    git_pull
  end

  desc 'æ„å»ºåçš„å‡†å¤‡å·¥ä½œ'
  desc "é’‰é’‰æœºå™¨äººç”¨æ¥å‘é€ä¸‹è½½åœ°å€é€šçŸ¥ç»™æµ‹è¯•ç¾¤"
  private_lane :dingdingtalk do |options|

    #
    app_version = lane_context[SharedValues::ANALYZE_APK_VERSION_NAME]
    app_build_version = lane_context[SharedValues::ANALYZE_APK_VERSION_CODE]
    app_name    = lane_context[SharedValues::ANALYZE_APK_APP_NAME]

    UI.message("Start get app information from pgyer...")

    if options[:type] == "flavorRelease"
      params = {
        "_api_key" => ""**************************",",
        "appKey" => ""**************************","
      }
      app_desc = "å†…æµ‹ç‰ˆ"
    elsif options[:type] == "flavorTest"
       params = {
        "_api_key" => ""**************************",",
        "appKey" => ""**************************","
      }
    elsif options[:type] == "flavorPro"
      app_desc = "é¢„ç”Ÿäº§ç‰ˆ"
      params = {
         "_api_key" => ""**************************",",
         "appKey" => ""**************************","
       }
    end

    UI.message("æµ‹è¯•")
    # è·å–Appè¯¦ç»†ä¿¡æ¯
    response = Net::HTTP.post_form URI('https://www.pgyer.com/apiv2/app/view'), params
    result = JSON.parse(response.body)

    UI.message(result)

    status_code = result["code"]
    status_message = result["message"]


    if status_code != 0
      UI.error('pgyer error message: ' + status_message)
      return
    end


    UI.success("Successfully get app information from pgyer!")
    app_url = "https://www.pgyer.com/" + result["data"]["buildShortcutUrl"]
    app_icon = "https://www.pgyer.com/image/view/app_icons/" + result["data"]["buildIcon"] + "/144"
    dingTalk_url = "https://oapi.dingtalk.com/robot/send?access_token=2d7f5962a839b2f9503db11c12d6b20c21349206a9e86e8550edcd6d05a43260"

    markdown =
    {
      msgtype: "link",
      link: {
          text: "å·²ç»æ›´æ–°å•¦ï¼Œå¿«æ¥è¯•è¯•å§!",
          title: "Android #{app_name} #{app_version} (#{app_build_version}) #{app_desc}",
          picUrl: "#{app_icon}",
          messageUrl: "#{app_url}"
      }
    }

    uri = URI.parse(dingTalk_url)
    https = Net::HTTP.new(uri.host, uri.port)
    https.use_ssl = true

    request = Net::HTTP::Post.new(uri.request_uri)
    request.add_field('Content-Type', 'application/json')
    request.body = markdown.to_json

    response = https.request(request)

    json = JSON.parse(response.body)

    if json["errcode"] != 0
      UI.error('ding talk error message: ' +  json["errmsg"])
    end
    UI.success("Successfully send link message to ding talk!")
  end


  desc "æ‹‰å–Gitæœ€æ–°ä»£ç ï¼Œæ‰“åŒ…APKï¼Œæäº¤åˆ°è’²å…¬è‹±"
  lane :submit_to_pgy do |options|

    if options[:flavor].nil?
      UI.error('need flavor options')
    end

    prepare

    gradle(task: "clean")
    # gradle(task: "assembleRelease")
    gradle(task:'assemble', flavor:options[:flavor], build_type:'Release')

     analyze_apk(
      android_home: ENV["JG_ANDROID_SDK_DIR"],
      build_tools_version: '26.0.3',
      apk_path: lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
    )

    pgyer(
      api_key: "**************************",
      user_key: ""**************************",",
      update_description: "android#{lane_context[SharedValues::ANALYZE_APK_APP_NAME]}å†…éƒ¨æµ‹è¯•ç‰ˆæœ¬å‘å¸ƒ by fastlane"
    )

    dingdingtalk(type:options[:flavor])
  end
end

```

### æ‰§è¡Œé…ç½®å¥½çš„è‡ªåŠ¨å‘å¸ƒè„šæœ¬

```
$ fastlane android submit_to_pgy flavor:flavorTest
```

## Fastfile

### å‘½ä»¤è¡Œå·¥å…·
å®‰è£…ä¹‹åé»˜è®¤ä¼šå®‰è£…ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…· fastlaneï¼Œåˆ©ç”¨å®ƒå¯ä»¥åˆå§‹åŒ–ã€æ‰§è¡Œä»»åŠ¡ã€æŸ¥çœ‹ä»»åŠ¡å®šä¹‰ã€æŸ¥çœ‹å¯ç”¨çš„åŠ¨ä½œå’ŒåŠ¨ä½œçš„è¯¦ç»†å®šä¹‰ï¼Œç”šè‡³å¯ä»¥ç”¨å®ƒæ¥åˆ›å»ºè‡ªå®šä¹‰çš„åŠ¨ä½œã€æ’ä»¶ä»¥åŠä¸€äº›è¾…åŠ©åŠŸèƒ½ã€‚æƒ³äº†è§£çš„è¯å¯ä»¥å…ˆçœ‹çœ‹å®ƒçš„å¸®åŠ©ï¼š

```
$ fastlane --help

  fastlane

  CLI for 'fastlane' - The easiest way to automate building and releasing your iOS and Android apps

        Run using `fastlane [platform] [lane_name]`
        To pass values to the lanes use `fastlane [platform] [lane_name] key:value key2:value2`

  Commands:
    action                  Shows more information for a specific command
    actions                 Lists all available fastlane actions
    add_plugin              Add a new plugin to your fastlane setup
    disable_crash_reporting Deprecated: fastlane doesn't use a crash reporter any more
    docs                    Generate a markdown based documentation based on the Fastfile
    enable_auto_complete    Enable tab auto completion
    enable_crash_reporting  Deprecated: fastlane doesn't use a crash reporter any more
    help                    Display global or [command] help documentation
    init                    Helps you with your initial fastlane setup
    install_plugins         Install all plugins for this project
    lanes                   Lists all available lanes and shows their description
    list                    Lists all available lanes without description
    new_action              Create a new custom action for fastlane.
    new_plugin              Create a new plugin that can be used with fastlane
    run                     Run a fastlane one-off action without a full lane
    search_plugins          Search for plugins, search query is optional
    trigger                 Run a sepcific lane. Pass the lane name and optionally the platform first.
    update_plugins          Update all plugin dependencies

  Global Options:
    --verbose
    -h, --help           Display help documentation
    -v, --version        Display version information

  Author:
    Felix Krause <fastlane@krausefx.com>

  Website:
    https://fastlane.tools

  GitHub:
    https://github.com/fastlane/fastlane
```

### Fastfileç”Ÿå‘½å‘¨æœŸ

ç”Ÿå‘½å‘¨æœŸ

| **æ‰§è¡Œé¡ºåº**	| **æ–¹æ³•å**			| **è¯´æ˜** 									|
| -------- 		| ----------------	| --------------------------------			|
| 1     		| before_all		| åœ¨æ‰§è¡Œ lane ä¹‹å‰åªæ‰§è¡Œä¸€æ¬¡     				|
| 2     		| before_each		| æ¯æ¬¡æ‰§è¡Œ lane ä¹‹å‰éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡     			|
| 3     		| lanes     		| è‡ªå®šä¹‰çš„ä»»åŠ¡     							|
| 4     		| after_each     	| æ¯æ¬¡æ‰§è¡Œ lane ä¹‹åéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡     			|
| 5     		| after_all     	| åœ¨æ‰§è¡Œ lane æˆåŠŸç»“æŸä¹‹åæ‰§è¡Œä¸€æ¬¡     			|
| 6     		| error     		| åœ¨æ‰§è¡Œä¸Šè¿°æƒ…å†µä»»æ„ç¯å¢ƒæŠ¥é”™éƒ½ä¼šä¸­æ­¢å¹¶æ‰§è¡Œä¸€æ¬¡    	|

### ä»»åŠ¡ï¼ˆlaneï¼‰
æ­£å¸¸æƒ…å†µä¸‹ä½ å¯èƒ½åªä¼šæ˜¯ç”¨åˆ°ä¸€ç§ä»»åŠ¡æ–¹æ³• lane ä½†å…¶å®å®ƒä¼šåŒ…å«å¾ˆå¤šä¸­é«˜çº§ç”¨æ³•ã€‚

### ä»»åŠ¡å®šä¹‰
å®šä¹‰ä»»åŠ¡çš„æ–¹æ³•ç±»ä¼¼äº rake çš„ taskï¼Œä½†ä½¿ç”¨ä¸Šç¼ºæ¯”å‰è€…è¦å¥½ç”¨å¾ˆå¤šï¼Œè§ä¸‹è¡¨ï¼š

| **å®šä¹‰** 	| **æ˜¯å¦å¿…é¡»**	| **è¯´æ˜** 	|	**å¤‡æ³¨**							|
| -------- 	| ------------	| --------	| --------------------------		|
| desc		| false			| æ–¹æ³•æè¿°	| å¯å¤šæ¬¡ä½¿ç”¨æ‰“åˆ°æ¢è¡Œçš„ç›®çš„				| 
| name		| true			| æ–¹æ³•å		| ç¬¦å·åŒ–çš„æ–¹æ³•å						| 
| options	| false			| æ–¹æ³•å‚æ•°	| è¿”å› Hash ç±»å‹						| 
| task		| true			| æ–¹æ³•ä¸»ä½“	| å‚è€ƒ ruby çš„æ–¹æ³•ä»£ç ä¸”æ”¯æŒ ruby ä»£ç 	| 




